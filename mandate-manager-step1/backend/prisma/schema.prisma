// backend/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  AGENT
}

enum MandateStatus {
  AVAILABLE
  RESERVED
  SIGNED
}

enum AllocationStatus {
  RESERVED
  DRAFT
  SIGNED
  RELEASED
}

enum FileKind {
  DRAFT
  SIGNED
}

model User {
  id          String              @id @default(cuid())
  email       String              @unique
  password    String
  role        Role
  active      Boolean             @default(true)
  firstName   String?
  lastName    String?
  createdAt   DateTime            @default(now())
  allocations MandateAllocation[]
}

model MandateNumber {
  id          String              @id @default(cuid())
  code        String              @unique
  year        Int
  seq         Int
  status      MandateStatus       @default(AVAILABLE)
  allocations MandateAllocation[]

  @@unique([year, seq])
  @@index([status, year, seq])
}

model MandateAllocation {
  id              String            @id @default(cuid())
  userId          String
  mandateNumberId String
  status          AllocationStatus  @default(RESERVED)
  reservedAt      DateTime          @default(now())
  deadlineAt      DateTime?
  signedAt        DateTime?
  releasedAt      DateTime?

  user     User          @relation(fields: [userId], references: [id])
  mandate  MandateNumber @relation(fields: [mandateNumberId], references: [id])
  files    MandateFile[]

  @@index([status, deadlineAt])
}

model MandateFile {
  id           String       @id @default(cuid())
  allocationId String
  kind         FileKind
  createdAt    DateTime     @default(now())
  storageKey   String
  sha256       String

  allocation MandateAllocation @relation(fields: [allocationId], references: [id])
}
